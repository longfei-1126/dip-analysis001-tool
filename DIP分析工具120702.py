# app.py
import streamlit as st
import pandas as pd
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import numpy as np

# é¡µé¢é…ç½®ï¼ˆå¿…é¡»æ”¾åœ¨æœ€å‰é¢ï¼‰
st.set_page_config(
    page_title="DIPç—…ç§åˆ†æå·¥å…·",
    page_icon="ğŸ¥",
    layout="wide",
    initial_sidebar_state="expanded"
)

# åˆ›å»ºé»˜è®¤æ•°æ®åº“
def create_default_dip_database():
    """åˆ›å»ºé»˜è®¤çš„DIPç—…ç§ç›®å½•"""
    data = {
        'åºå·': [1, 2, 3, 4],
        'DIPç¼–ç ': ['B11.0S001', 'C12.0T001', 'D13.0S001', 'H25.0S002'],
        'DIPåç§°': ['é«˜è¡€å‹ç—…-æ‰‹æœ¯ç»„01', 'ç³–å°¿ç—…-æ²»ç–—ç»„01', 'å† å¿ƒç—…-æ‰‹æœ¯ç»„01', 'è€å¹´æ€§åˆæœŸç™½å†…éšœ-æ‰‹æœ¯ç»„02'],
        'ç—…ç§ç±»å‹': ['æ ¸å¿ƒç—…ç§', 'æ ¸å¿ƒç—…ç§', 'æ ¸å¿ƒç—…ç§', 'åŸºå±‚ç—…ç§'],
        'è¯Šæ–­ç¼–ç ': ['I10', 'E11.9', 'I25.1', 'H25.0'],
        'è¯Šæ–­åç§°': ['ç‰¹å‘æ€§é«˜è¡€å‹', '2å‹ç³–å°¿ç—…', 'åŠ¨è„‰ç²¥æ ·ç¡¬åŒ–æ€§å¿ƒè„ç—…', 'è€å¹´æ€§åˆæœŸç™½å†…éšœ'],
        'æ“ä½œç¼–ç ': ['æ— ', 'æ— ', '36.06', '13.4100x001'],
        'æ“ä½œåç§°': ['æ— ', 'æ— ', 'å† çŠ¶åŠ¨è„‰æ­æ¡¥æœ¯', 'ç™½å†…éšœè¶…å£°ä¹³åŒ–æŠ½å¸æœ¯'],
        'ç—…ä¾‹æ•°': [1000, 800, 500, 7568],
        'å…¥ç»„çš„DIPåŸºå‡†åˆ†å€¼': [15.5000, 12.3000, 45.2000, 78.0521]
    }
    return pd.DataFrame(data)

# åˆå§‹åŒ–session
if 'dip_database' not in st.session_state:
    st.session_state.dip_database = create_default_dip_database()
if 'dip_base_score' not in st.session_state:
    st.session_state.dip_base_score = 27.7173

# åº”ç”¨æ ‡é¢˜
st.title('ğŸ¥ DIPç—…ç§åŠè´¹ç”¨åˆ†æå·¥å…·')
st.markdown("---")

# ä¾§è¾¹æ 
st.sidebar.header('âš™ï¸ å‚æ•°è®¾ç½®')

# è´¹ç”¨å‚æ•°
col1, col2 = st.sidebar.columns(2)
with col1:
    è¯Šç–—è´¹ç”¨ = st.number_input('è¯Šç–—è´¹ç”¨(å…ƒ)', min_value=0, value=3936.93, step=100.0)
    æ£€æŸ¥æ£€éªŒè´¹ç”¨ = st.number_input('æ£€æŸ¥æ£€éªŒè´¹ç”¨(å…ƒ)', min_value=0.0, value=3348.15, step=100.0)
with col2:
    è¯å“è´¹ç”¨ = st.number_input('è¯å“è´¹ç”¨(å…ƒ)', min_value=0.0, value=2001.41, step=100.0)
    è€—æè´¹ç”¨ = st.number_input('è€—æè´¹ç”¨(å…ƒ)', min_value=0.0, value=3115.78, step=100.0)

# å…¶ä»–å‚æ•°
åŒ»ç–—æ€§æ”¶å…¥æˆæœ¬ç‡ = st.sidebar.slider('åŒ»ç–—æ€§æ”¶å…¥æˆæœ¬ç‡', 0.0, 1.0, 0.50, 0.01)
è¯è€—æˆæœ¬ç‡ = st.sidebar.slider('è¯è€—æˆæœ¬ç‡', 0.0, 1.5, 1.00, 0.01)
ç»Ÿç­¹åŸºé‡‘æ”¯ä»˜é‡‘é¢ = st.sidebar.number_input('ç»Ÿç­¹åŸºé‡‘æ”¯ä»˜é‡‘é¢(å…ƒ)', min_value=0.0, value=7657.03, step=100.0)
åŒ»é™¢ç­‰çº§ç³»æ•° = st.sidebar.number_input('åŒ»é™¢ç­‰çº§ç³»æ•°', min_value=0.5, max_value=2.0, value=1.0330, step=0.0001, format="%.4f")
ç‚¹å€¼ = st.sidebar.number_input('ç‚¹å€¼', min_value=0.0, max_value=200.0, value=73.6011, step=0.0001, format="%.4f")

# DIPåŸºå‡†åˆ†å€¼
st.sidebar.header('ğŸ“Š DIPåˆ†å€¼')
å…¥ç»„çš„DIPåŸºå‡†åˆ†å€¼ = st.sidebar.number_input(
    'å…¥ç»„çš„DIPåŸºå‡†åˆ†å€¼',
    min_value=0.0,
    value=float(st.session_state.dip_base_score),
    step=0.0001,
    format="%.4f"
)

# è®¡ç®—æŒ‰é’®
if st.sidebar.button('ğŸ“ˆ å¼€å§‹è®¡ç®—', type='primary', use_container_width=True):
    # è®¡ç®—å…¥ç»„çš„DIPåˆ†å€¼
    å…¥ç»„çš„DIPåˆ†å€¼ = å…¥ç»„çš„DIPåŸºå‡†åˆ†å€¼ * åŒ»é™¢ç­‰çº§ç³»æ•°
    
    # è®¡ç®—è´¹ç”¨æ€»å’Œ
    ä½é™¢æ€»è´¹ç”¨ = è¯Šç–—è´¹ç”¨ + æ£€æŸ¥æ£€éªŒè´¹ç”¨ + è¯å“è´¹ç”¨ + è€—æè´¹ç”¨
    åŒ»ç–—æ€§æ”¶å…¥ = è¯Šç–—è´¹ç”¨ + æ£€æŸ¥æ£€éªŒè´¹ç”¨
    è¯è€—æ”¶å…¥ = è¯å“è´¹ç”¨ + è€—æè´¹ç”¨
    
    # è®¡ç®—æ²»ç–—æˆæœ¬
    æ²»ç–—æˆæœ¬ = åŒ»ç–—æ€§æ”¶å…¥ * åŒ»ç–—æ€§æ”¶å…¥æˆæœ¬ç‡ + è¯è€—æ”¶å…¥ * è¯è€—æˆæœ¬ç‡
    
    # è®¡ç®—ç—…äººè‡ªä»˜é‡‘é¢
    ç—…äººè‡ªä»˜é‡‘é¢ = ä½é™¢æ€»è´¹ç”¨ - ç»Ÿç­¹åŸºé‡‘æ”¯ä»˜é‡‘é¢
    
    # è®¡ç®—DIPæ”¯ä»˜æ ‡å‡†
    DIPæ”¯ä»˜æ ‡å‡† = å…¥ç»„çš„DIPåˆ†å€¼ * ç‚¹å€¼
    
    # è®¡ç®—æ ¸ç®—é‡‘é¢ï¼ˆæ ¹æ®æ–°çš„DIPä»˜è´¹åŠæ³•ï¼ŒDIPæ ¸ç®—é‡‘é¢ä¸ºè´Ÿæ•°æ—¶è®¡ç®—ä¸º0ï¼‰
    DIPæ ¸ç®—é‡‘é¢ = max(DIPæ”¯ä»˜æ ‡å‡† - ç—…äººè‡ªä»˜é‡‘é¢, 0)
    
    # è®¡ç®—ç›®æ ‡æŒ‡æ ‡
    ç—…ä¾‹çœŸå®ç›ˆäºé‡‘é¢ = DIPæ”¯ä»˜æ ‡å‡† - æ²»ç–—æˆæœ¬
    DIPå›æ¬¾ç‡ = DIPæ ¸ç®—é‡‘é¢ / ç»Ÿç­¹åŸºé‡‘æ”¯ä»˜é‡‘é¢ if ç»Ÿç­¹åŸºé‡‘æ”¯ä»˜é‡‘é¢ != 0 else 0
    DIPç›ˆäºé‡‘é¢ = DIPæ ¸ç®—é‡‘é¢ - ç»Ÿç­¹åŸºé‡‘æ”¯ä»˜é‡‘é¢
    
    # æ˜¾ç¤ºç»“æœ
    st.success("âœ… è®¡ç®—å®Œæˆï¼")
    
    # å…³é”®æŒ‡æ ‡å¡ç‰‡
    col1, col2, col3 = st.columns(3)
    with col1 st.metric("ç—…ä¾‹çœŸå®ç›ˆäºé‡‘é¢", f"Â¥{ç—…ä¾‹çœŸå®ç›ˆäºé‡‘é¢:,.2f}", 
                 delta="ç›ˆåˆ©" if ç—…ä¾‹çœŸå®ç›ˆäºé‡‘é¢ >= 0 else "äºæŸ",
                 delta_color="normal" if ç—…ä¾‹çœŸå®ç›ˆäºé‡‘é¢ >= 0 else "inverse")
    with col2:
        st.metric("DIPå›æ¬¾ç‡", f"{DIPå›æ¬¾ç‡:.2%}")
    with col3:
        st.metric("DIPç›ˆäºé‡‘é¢", f"Â¥{DIPç›ˆäºé‡‘é¢:,.2f}",
                 delta="ç›ˆåˆ©" if DIPç›ˆäºé‡‘é¢ >= 0 else "äºæŸ",
                 delta_color="normal" if DIPç›ˆäºé‡‘é¢ >= 0 else "inverse")
    
    # è´¹ç”¨ç»“æ„å›¾è¡¨
    st.subheader("ğŸ’° è´¹ç”¨ç»“æ„åˆ†æ")
    è´¹ç”¨åˆ†ç±» = ['è¯Šç–—è´¹ç”¨', 'æ£€æŸ¥æ£€éªŒè´¹ç”¨', 'è¯å“è´¹ç”¨', 'è€—æè´¹ç”¨']
    è´¹ç”¨æ•°å€¼ = [è¯Šç–—è´¹ç”¨, æ£€æŸ¥æ£€éªŒè´¹ç”¨, è¯å“è´¹ç”¨, è€—æè´¹ç”¨]
    
    fig1 = go.Figure(data=[go.Pie(
        labels=è´¹ç”¨åˆ†ç±», 
        values=è´¹ç”¨æ•°å€¼,
        hole=.3,
        marker_colors=['#1E88E '#FFC107', '#4CAF50', '#F44336']
    )])
    fig1.update_layout(title_text="è´¹ç”¨ç»“æ„åˆ†å¸ƒ")
    st.plotly_chart(fig1, use_container_width=True)
    
    # è¯¦ç»†æ•°æ®è¡¨æ ¼
    st.subheader("ğŸ“Š è¯¦ç»†è®¡ç®—ç»“æœ")
    è¯¦ç»†æ•°æ® = {
        'æŒ‡æ ‡': ['ä½é™¢æ€»è´¹ç”¨', 'åŒ»ç–—æ€§æ”¶å…¥', 'è¯è€—æ”¶å…¥', 'æ²»ç–—æˆæœ¬', 
                'ç—…äººè‡ªä»˜é‡‘é¢', 'DIPæ”¯ä»˜æ ‡å‡†', 'DIPæ ¸ç®—é‡‘é¢',
                'ç—…ä¾‹çœŸå®ç›ˆäºé‡‘é¢', 'DIPç›ˆäºé‡‘é¢', 'DIPå›æ¬¾ç‡', 'å…¥ç»„çš„DIPåˆ†å€¼'],
        'æ•°å€¼': [
            f"ä½é™¢æ€»è´¹ç”¨:,.2f}",
            f"Â¥{åŒ»ç–—æ€§æ”¶å…¥:,.2f}",
            f"Â¥{è¯è€—æ”¶å…¥:,.2f}",
            f"Â¥{æ²»ç–—æˆæœ¬:,.2f}",
            f"Â¥{ç—…äººè‡ªä»˜é‡‘é¢:,.2f}",
            f"Â¥{DIPæ”¯ä»˜æ ‡å‡†:,.2f}",
            f"Â¥{DIPæ ¸ç®—é‡‘é¢:,.2f}",
            f"Â¥{ç—…ä¾‹çœŸå®ç›ˆäºé‡‘é¢:,.2f}",
            f"Â¥{DIPç›ˆäºé‡‘é¢:,.2f}",
            f"{DIPå›æ¬¾ç‡:.2%}",
            f"{å…¥ç»„çš„DIPåˆ†å€¼:.4f}"
        ]
    }
    
    df = pd.DataFrame(è¯¦ç»†æ•°æ®)
    st.dataframe(df, use_container_width=True, hide_index=True)
else:
    st.info("ğŸ‘ˆ è¯·åœ¨å·¦ä¾§è®¾ç½®å‚æ•°ï¼Œç„¶åç‚¹å‡»'å¼€å§‹è®¡ç®—'æŒ‰é’®")

# æ˜¾ç¤ºå½“å‰DIPæ•°æ®åº“
with st.expander("ğŸ“ æŸ¥çœ‹DIPæ•°æ®åº“", expanded=False):
    st.dataframe(st.session_state.dip_database, use_container_width=True)

# åº”ç”¨è¯´æ˜
st.sidebar.markdown("---")
st.sidebar.info("""
**ä½¿ç”¨è¯´æ˜ï¼š**
1. è®¾ç½®å„é¡¹è´¹ç”¨å‚æ•°
2.æˆæœ¬ç‡å’Œç³»æ•°
3. è®¾ç½®DIPåŸºå‡†åˆ†å€¼
4. ç‚¹å‡»"å¼€å§‹è®¡ç®—"
5. æŸ¥çœ‹åˆ†æç»“æœ
""")
